# .github/workflows/sync.yml - VERSI√ìN SIMPLIFICADA
name: Daily Strava Sync

on:
  schedule:
    - cron: '0 6 * * *'  # 6:00 AM UTC diariamente
  workflow_dispatch:     # Permitir ejecuci√≥n manual

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Trigger sync
      id: sync
      run: |
        echo "üöÄ Starting Strava data sync..."
        
        # Hacer request al webhook
        response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.SYNC_TOKEN }}" \
          -d '{"days": 7}' \
          "${{ secrets.RAILWAY_SYNC_WEBHOOK }}")
        
        # Extraer c√≥digo HTTP y respuesta
        http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
        body=$(echo $response | sed -e 's/HTTPSTATUS\:.*//g')
        
        echo "Response code: $http_code"
        echo "Response body: $body"
        
        # Verificar √©xito
        if [ $http_code -eq 200 ]; then
          echo "‚úÖ Sync triggered successfully"
          echo "sync_status=success" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Sync failed with HTTP $http_code"
          echo "sync_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Wait and verify
      if: steps.sync.outputs.sync_status == 'success'
      run: |
        echo "‚è≥ Waiting 60 seconds for sync to complete..."
        sleep 60
        
        echo "üîç Checking system health..."
        health=$(curl -s "${{ secrets.RAILWAY_APP_URL }}/health" || echo "ERROR")
        
        echo "Health check result: $health"
        
        if echo "$health" | grep -q '"status":"ok"'; then
          echo "‚úÖ System is healthy after sync"
        else
          echo "‚ö†Ô∏è System health check inconclusive"
        fi

    - name: Report status
      if: always()
      run: |
        echo "üìã SYNC SUMMARY"
        echo "=============="
        echo "Trigger status: ${{ steps.sync.outputs.sync_status }}"
        echo "Timestamp: $(date)"
        echo "Next sync: Tomorrow at 6:00 AM UTC"
        
        if [ "${{ steps.sync.outputs.sync_status }}" = "success" ]; then
          echo "üéâ Daily sync completed successfully!"
        else
          echo "üí• Sync failed - check Railway logs for details"
        fi